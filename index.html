
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>BalÄ±k AvÄ± Paneli â€“ Karadeniz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- ğŸ” Content Security Policy (CSP) -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' https://unpkg.com 'unsafe-inline';
  style-src  'self' https://unpkg.com 'unsafe-inline';
  img-src    'self' data: blob: https://*.tile.openstreetmap.org;
  connect-src 'self' https://api.open-meteo.com https://marine-api.open-meteo.com https://geocoding-api.open-meteo.com;
  font-src   'self' data:;
">

<!-- âœ… Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  :root{
    --bg: #0b1220;
    --fg: #ffffff;
    --panel: #111827;
    --border: #1e293b;
    --card: #111827;
    --chip: #1e293b;
    --accent: #2563eb;
    --muted: #e5e7eb;
    --region-bg: #1f2937;
    --region-bd: #374151;
    --toast-bg: #111827;
    --toast-fg: #ffffff;
    --toast-error: #ef4444;
  }
  body.light{
    --bg: #f8fafc;
    --fg: #0f172a;
    --panel: #ffffff;
    --border: #e2e8f0;
    --card: #ffffff;
    --chip: #e0e7ff;
    --accent: #2563eb;
    --muted: #1e293b;
    --region-bg: #f1f5f9;
    --region-bd: #cbd5e1;
    --toast-bg: #ffffff;
    --toast-fg: #0f172a;
    --toast-error: #dc2626;
  }
  body.ocean{
    --bg: #06151f;
    --fg: #e6f7ff;
    --panel: #0a1f2b;
    --border: #0f2f42;
    --card: #0c2433;
    --chip: #113a50;
    --accent: #00a0d2;
    --muted: #bfe9ff;
    --region-bg: #0e2b3d;
    --region-bd: #13506b;
  }
  body.forest{
    --bg: #0c1610;
    --fg: #eaffea;
    --panel: #132218;
    --border: #1a2f21;
    --card: #1a2c22;
    --chip: #224033;
    --accent: #22c55e;
    --muted: #caffc9;
  }

  html, body { height: 100%; }
  body{
    margin:0; font-family:system-ui,-apple-system,sans-serif;
    background:var(--bg); color:var(--fg); min-height:100dvh;
    transition:background .3s,color .3s; position:relative;
  }

  header{
    padding:16px; text-align:center; border-bottom:1px solid var(--border);
    position:relative; min-height:60px; display:flex; flex-direction:column; gap:8px; align-items:center;
  }
  h2{margin:0;font-size:22px; display:flex; align-items:center; gap:8px;}

  /* Toolbar: sadece tema seÃ§ici */
  .toolbar{
    position:absolute; top:12px; right:12px; display:flex; gap:8px; align-items:center;
  }
  .theme-select{
    background:var(--panel); color:var(--fg); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px; font-size:14px; cursor:pointer;
  }

  /* BÃ¶lge rozeti (tÄ±klanabilir) */
  .region-inline{
    display:inline-flex; align-items:center; gap:10px;
    background:var(--region-bg); border:2px solid var(--region-bd); color:var(--fg);
    border-radius:999px; padding:8px 14px; font-size:14px; font-weight:600;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
    cursor:pointer; transition: transform .15s ease, box-shadow .15s ease;
  }
  .region-inline:hover{ transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.35); }
  .region-inline:active{ transform: scale(0.98); }
  .region-inline:focus{ outline:none; box-shadow:0 0 0 3px rgba(37,99,235,.35); }

  /* Rozet iÃ§i yerleÅŸim: [ğŸ“ konum ikonu] [bÃ¶lge] [ÅŸehir] */
  .region-layout{
    display:inline-flex; align-items:center; gap:10px;
  }
  .region-text{
    display:inline-flex; align-items:center; gap:6px;
  }
  .region-chip{ font-weight:700; }
  .city-chip{ opacity:.95; }

  /* Rozet iÃ§indeki konum ikonu (tÄ±klanabilir ve animasyonlu) */
  .locate-icon{
    display:inline-flex; align-items:center; justify-content:center;
    width:24px; height:24px; border-radius:50%;
    background:rgba(255,255,255,0.12); border:1px solid var(--border);
    cursor:pointer; transition:transform .2s, box-shadow .2s, background .2s;
    position:relative;
  }
  .locate-icon:hover{ transform:scale(1.08); box-shadow:0 0 0 3px rgba(37,99,235,.35); background:rgba(255,255,255,0.18); }
  .locate-icon:active{ transform:scale(0.95); }
  .locate-icon::after{
    content:"";
    position:absolute; inset:-6px;
    border-radius:50%;
    box-shadow:0 0 0 0 rgba(37,99,235,0.6);
    animation:pulse 2.2s infinite;
  }
  @keyframes pulse{
    0%{ box-shadow:0 0 0 0 rgba(37,99,235,0.6); }
    70%{ box-shadow:0 0 0 12px rgba(37,99,235,0); }
    100%{ box-shadow:0 0 0 0 rgba(37,99,235,0); }
  }

  .location-panel{padding:16px;background:var(--panel);display:flex;flex-direction:column;gap:12px}
  .search-row{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
  .search-row > *{ flex:1 1 220px; min-width:180px; }
  .search-row .search-input{ flex:2 1 320px; min-width:260px; }
  .search-row .btn-search{ flex:0 0 120px; min-width:120px; }
  #locationInput{
    background:rgba(255,255,255,0.12); color:var(--fg); caret-color:var(--fg);
    border:1px solid var(--border); border-radius:12px; padding:12px 14px; font-size:16px
  }
  #locationInput::placeholder{opacity:.7}
  select{
    padding:12px 14px; background:var(--panel); color:var(--fg);
    border:1px solid var(--border); border-radius:12px; font-size:16px
  }
  #searchButton{
    background:var(--accent); color:#fff; border:none; border-radius:12px;
    padding:12px 14px; font-size:16px; font-weight:700; cursor:pointer; transition:all .2s
  }
  #searchButton:active{transform:scale(0.98)}

  #map{
    height:min(30dvh, 300px); margin:16px; border-radius:16px; overflow:hidden;
    box-shadow:0 8px 24px rgba(0,0,0,.4); position:relative; z-index:1
  }
  @media (min-width:768px){#map{height:min(35dvh, 300px)}}

  #loading{display:none;color:#16a34a;text-align:center;font-size:18px;padding:20px;font-weight:bold}

  .cards{
    padding:0 16px 16px; display:grid; gap:16px;
    grid-template-columns: repeat(1, minmax(280px, 1fr));
    overflow:auto; -webkit-overflow-scrolling:touch;
    position:relative;
  }
  @media (min-width:768px){
    .cards{ padding:0 24px 24px; grid-template-columns: repeat(2, minmax(300px, 1fr)); gap:18px; }
  }
  @media (min-width:992px){
    .cards{ padding:0 32px 32px; grid-template-columns: repeat(3, minmax(300px, 1fr)); gap:20px; }
  }
  @media (min-width:1280px){
    .cards{ padding:0 40px 40px; grid-template-columns: repeat(4, minmax(280px, 1fr)); gap:22px; }
  }

  .card{
    background:var(--card); border-radius:16px; padding:16px;
    box-shadow:0 6px 20px rgba(0,0,0,.35); transition:all .2s ease; cursor:pointer; border:1px solid var(--border);
    outline:none;
  }
  .card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 12px 28px rgba(0,0,0,.45)}
  .card:active{transform:scale(0.96)}
  .card:focus{box-shadow:0 0 0 3px var(--accent)}

  .top3{margin-top:8px;opacity:.95}
  .top3 .chip{
    display:inline-block; background:var(--chip); border-radius:999px;
    padding:4px 8px; margin:2px 4px 0 0; font-size:12px; border:1px solid var(--border)
  }

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;z-index:2000;align-items:flex-end;justify-content:center}
  .sheet{width:100%;max-height:90vh;background:var(--panel);border-radius:24px 24px 0 0;padding:20px;overflow-y:auto;box-shadow:0 -20px 40px rgba(0,0,0,.6);position:relative;z-index:2001; border:1px solid var(--border)}
  .modal-top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;position:relative}
  .modal-top-bar h3{margin:0;flex:1;text-align:center;font-size:18px}
  .modal-actions{display:flex;gap:12px;align-items:center}
  .close,.share-button{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;transition:all .2s}
  .close{background:rgba(255,255,255,0.1); border:1px solid var(--border)}
  .close:active{transform:scale(0.9);background:rgba(255,255,255,0.2)}
  .share-button{background:var(--accent); color:#fff; border:1px solid var(--border)}
  .share-button:active{transform:scale(0.9)}
  .timeline{display:flex;gap:10px;margin:16px 0;overflow-x:auto;padding-bottom:8px}
  .slot{padding:10px 12px;border-radius:12px;background:var(--chip);cursor:pointer;font-size:13px;min-width:140px;text-align:center;transition:all .2s; border:1px solid var(--border); color:var(--fg)}
  .slot:hover{transform:scale(1.05)}
  .slot:active{transform:scale(0.95)}
  .slot.active{background:var(--accent);color:#fff;border-color:transparent}
  .env-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:16px 0}
  @media (min-width:768px) and (max-width:1024px){.env-grid{grid-template-columns:repeat(3,1fr);gap:16px}}
  .env-box{background:var(--chip);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;font-size:14px;color:var(--fg)}

  .fish{background:var(--chip);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 12px rgba(0,0,0,.3);transition:all .2s;color:var(--fg)}
  .fish:active{transform:scale(0.98)}
  .fish-head{display:flex;justify-content:space-between;align-items:center;font-size:18px;font-weight:bold;padding-bottom:10px}
  .detail{margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
  .av-comment{font-size:15px;font-weight:bold;margin:12px 0;padding:12px;border-radius:12px;text-align:center;background:rgba(0,0,0,0.2); color:var(--fg)}
  .bar{width:100%; height:10px; background:var(--border); border-radius:8px; overflow:hidden; margin:8px 0}
  .bar > div{height:100%; background:#16a34a; transition:width .3s ease}
  .takim-yem .small{line-height:1.6}
  .nadir{display:inline-block;margin-top:6px;font-size:12px;background:transparent;color:var(--fg);border:1px dashed var(--border);border-radius:8px;padding:4px 8px}

  .toast{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    background:var(--toast-bg); color:var(--toast-fg);
    padding:10px 14px; border-radius:10px; z-index:3000; box-shadow:0 10px 20px rgba(0,0,0,.35);
    border:1px solid var(--border); min-width:240px; text-align:center;
  }
  .toast.error{ background:var(--toast-error); color:#fff; }

  /* ğŸ“± Mobil scroll ipucu (kartlarÄ±n Ã¼st kÄ±smÄ±nda) */
  .scroll-hint{
    position:absolute; top:-8px; left:0; right:0; height:44px;
    pointer-events:none; display:none;
  }
  .scroll-hint .fade{
    position:absolute; inset:0;
    background:linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
    border-radius:12px;
  }
  .scroll-hint .msg{
    position:absolute; top:4px; left:50%; transform:translateX(-50%);
    background:rgba(17,24,39,.8); color:#fff; font-size:12px; padding:6px 10px;
    border-radius:999px; border:1px solid rgba(255,255,255,.15);
    display:flex; align-items:center; gap:6px;
  }
  .scroll-hint .chev{
    animation:bounce 1.2s infinite;
  }
  @keyframes bounce{
    0%,100%{ transform:translateY(0); }
    50%{ transform:translateY(4px); }
  }
  @media (max-width:767px){
    .scroll-hint{ display:block; }
  }
</style>
</head>
<body class="">
<header>
  <div class="toolbar">
    <!-- Tema seÃ§ici -->
    <select id="themeSelect" class="theme-select" aria-label="Tema seÃ§imi">
      <option value="">Koyu</option>
      <option value="light">AÃ§Ä±k</option>
      <option value="ocean">Okyanus</option>
      <option value="forest">Orman</option>
    </select>
  </div>
  <h2>ğŸ£ BalÄ±k AvÄ± Paneli</h2>

  <!-- ğŸ“ BÃ¶lge rozeti: [ikon] [BatÄ± Karadeniz] â€“ [Amasra] -->
  <div class="region-inline" id="regionInline" role="button" tabindex="0" aria-label="Mevcut konuma git">
    <div class="region-layout">
      <span id="regionLocateIcon" class="locate-icon" role="button" aria-label="Konumumu kullan" title="Konumumu kullan">ğŸ“</span>
      <span class="region-text">
        <span id="regionName" class="region-chip">BatÄ± Karadeniz</span>
        <span>â€“</span>
        <span id="cityName" class="city-chip">Amasra</span>
      </span>
    </div>
  </div>
</header>

<div class="location-panel">
  <div class="search-row">
    <input class="search-input" type="text" id="locationInput" placeholder="Åehir/Ä°lÃ§e girin (Ã¶r: Amasra)" list="locationSuggestions" aria-label="Lokasyon arama">
    <datalist id="locationSuggestions"></datalist>

    <select id="recentLocations" aria-label="Son Lokasyonlar">
      <option value="">Son Lokasyonlar</option>
    </select>

    <select id="dateSelect" aria-label="Tarih seÃ§imi"></select>

    <button id="searchButton" class="btn-search" aria-label="Ara">Ara</button>
  </div>
</div>

<div id="map"></div>
<div id="loading" role="status" aria-live="polite">Veriler yÃ¼kleniyor, lÃ¼tfen bekleyin...</div>

<!-- ğŸ“± Mobil scroll ipucu konteyner -->
<div class="cards" id="cards">
  <div class="scroll-hint" id="scrollHint">
    <div class="fade"></div>
    <div class="msg">AÅŸaÄŸÄ± kaydÄ±rÄ±n <span class="chev">â¬‡ï¸</span></div>
  </div>
</div>

<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="slotTitle">
  <div class="sheet" tabindex="-1" id="modalSheet">
    <div class="modal-top-bar">
      <div class="modal-actions">
        <button class="share-button" id="shareButton" aria-label="Paneli paylaÅŸ">ğŸ“¤</button>
      </div>
      <h3 id="slotTitle"></h3>
      <div class="modal-actions">
        <div class="close" id="modalClose" aria-label="Kapat" role="button">âœ–</div>
      </div>
    </div>
    <div class="timeline" id="timeline"></div>
    <div class="env-grid" id="envGrid"></div>
    <div id="fishList"></div>
  </div>
</div>

<!-- âœ… Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* === YardÄ±mcÄ±lar === */
function pad2(n){ return String(n).padStart(2,'0'); }
function fishIconCount(score){
  if (score >= 90) return 5;
  if (score >= 80) return 4;
  if (score >= 60) return 3;
  if (score >= 40) return 2;
  if (score >= 20) return 1;
  return 0;
}
function fishIcons(score){ return 'ğŸŸ'.repeat(fishIconCount(score)); }
function escapeHTML(s){
  if (s == null) return '';
  return String(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'",'&#39;');
}
function showToast(msg, type='info'){
  const el = document.createElement('div');
  el.className = 'toast' + (type==='error' ? ' error' : '');
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 3000);
}
function buildThreeHourSlots() {
  const make = (startHour) => ({
    t: `${pad2(startHour)}:00 - ${pad2(startHour + 3)}:00`,
    hours: [startHour, startHour + 1, startHour + 2],
    timeLabel: "GÃœNDÃœZ"
  });
  return [ make(0), make(3), make(6), make(9), make(12), make(15), make(18), make(21) ];
}
function labelBySunClock(hour, sunriseStr, sunsetStr) {
  const toMin = s => { const [H,M] = String(s||'06:00').split(':').map(Number); return H*60 + M; };
  const hMin = hour*60;
  const sr = sunriseStr ? toMin(sunriseStr) : 6*60;
  const ss = sunsetStr ? toMin(sunsetStr) : 18*60;
  const twilightWindow = 60;
  if (hMin < sr - twilightWindow || hMin > ss + twilightWindow) return "GECE";
  if (Math.abs(hMin - sr) <= twilightWindow || Math.abs(hMin - ss) <= twilightWindow) return "ALACAKARANLIK";
  return "GÃœNDÃœZ";
}

/* === Tema yÃ¶netimi === */
const themeSelect = document.getElementById('themeSelect');
function applyThemeClass(cls){
  document.body.classList.remove('light','ocean','forest');
  if (cls) document.body.classList.add(cls);
  localStorage.setItem('fishingThemeClass', cls || '');
}
(function initTheme(){
  const saved = localStorage.getItem('fishingThemeClass') || '';
  themeSelect.value = saved;
  applyThemeClass(saved);
})();
themeSelect.addEventListener('change', (e)=> applyThemeClass(e.target.value));

/* === Debounce === */
const debounce = (fn, wait=250) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; };

/* === Region === */
const RegionModule = {
  textMap: { "BatÄ±":"BatÄ± Karadeniz", "Orta":"Orta Karadeniz", "DoÄŸu":"DoÄŸu Karadeniz" },
  getRegion(lat, lon){ if (lon < 35.5) return "BatÄ±"; if (lon < 38.2) return "Orta"; return "DoÄŸu"; },
  updateInline(cityText){
    const regionText = this.textMap[App.currentRegion] || "â€”";
    document.getElementById('regionName').textContent = regionText;
    document.getElementById('cityName').textContent = cityText || 'â€”';
  }
};

/* === App === */
const App = {
  currentLat: 41.65, currentLon: 32.38, currentDateOffset: 0, currentLocationName: "Amasra", currentRegion: "BatÄ±",

  init() {
    this.currentRegion = RegionModule.getRegion(this.currentLat, this.currentLon);
    RegionModule.updateInline(this.currentLocationName);
    MapModule.init();
    this.loadRecentLocations();
    this.populateDateSelect();
    this.loadLastUsedLocation();
    this.bindSearchSuggestions();
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') UIModule.closeModal(); });
    sizeLayout();
    setupModalInteractions();
    setupRegionInline();       // Rozete tÄ±klayÄ±nca mevcut konuma odakla
    setupRegionLocateIcon();   // Rozet iÃ§indeki ğŸ“ ikon ile geolokasyon al
    setupScrollHint();         // Mobil scroll ipucu
  },

  populateDateSelect() {
    const select = document.getElementById('dateSelect'); select.innerHTML = '';
    const today = new Date();
    for (let i = 0; i < 8; i++) {
      const d = new Date(today); d.setDate(today.getDate() + i);
      const opt = document.createElement('option'); opt.value = i;
      opt.textContent = i===0 ? 'BugÃ¼n' : i===1 ? 'YarÄ±n' : d.toLocaleDateString('tr-TR',{weekday:'long', day:'numeric', month:'long'});
      select.appendChild(opt);
    }
    select.value = this.currentDateOffset;
    select.onchange = () => this.updateForecast();
  },

  bindSearchSuggestions(){
    const input = document.getElementById('locationInput');
    const datalist = document.getElementById('locationSuggestions');
    input.addEventListener('input', debounce(async (e)=>{
      const q = e.target.value.trim(); if(!q){ datalist.innerHTML=''; return; }
      try{
        const res = await fetchWithTimeout(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=tr`, 12000);
        const data = await res.json();
        datalist.innerHTML = '';
        (data.results||[]).slice(0,5).forEach(r=>{
          const opt = document.createElement('option');
          opt.value = `${r.name}${r.country_code ? ' ('+r.country_code+')' : ''}`;
          datalist.appendChild(opt);
        });
      }catch(err){ /* sessiz */ }
    }, 300));
  },

  searchLocation(){ const q = document.getElementById('locationInput').value.trim(); if(!q) return; MapModule.searchLocation(q); },

  updateForecast(){ this.currentDateOffset = parseInt(document.getElementById('dateSelect').value); APIModule.fetchData(this.currentLat, this.currentLon, this.currentDateOffset); },

  setLocation(lat, lon, name="SeÃ§ilen Konum"){
    this.currentLat = lat; this.currentLon = lon; this.currentLocationName = name;
    this.currentRegion = RegionModule.getRegion(lat, lon);
    RegionModule.updateInline(name);
    this.saveRecentLocation(lat, lon, name);
    this.updateForecast();
    sizeLayout();
  },

  saveRecentLocation(lat, lon, name){
    let recents = JSON.parse(localStorage.getItem('fishingRecents') || '[]');
    recents = recents.filter(l => !(Math.abs(l.lat - lat) < 0.01 && Math.abs(l.lon - lon) < 0.01));
    recents.unshift({lat, lon, name}); recents = recents.slice(0, 5);
    localStorage.setItem('fishingRecents', JSON.stringify(recents));
    this.loadRecentLocations();
  },

  loadRecentLocations(){
    const select = document.getElementById('recentLocations');
    select.innerHTML = '<option value="">Son Lokasyonlar</option>';
    const recents = JSON.parse(localStorage.getItem('fishingRecents') || '[]');
    recents.forEach(loc => {
      const o=document.createElement('option'); o.value=JSON.stringify(loc); o.textContent=loc.name;
      select.appendChild(o);
    });
    select.onchange = (e) => this.loadRecentLocation(e.target.value);
  },

  loadRecentLocation(value){
    if (!value) return; const loc = JSON.parse(value);
    this.setLocation(loc.lat, loc.lon, loc.name);
    document.getElementById('locationInput').value = loc.name;
    MapModule.map.setView([loc.lat, loc.lon], 10);
    if (MapModule.marker) MapModule.map.removeLayer(MapModule.marker);
    MapModule.marker = L.marker([loc.lat, loc.lon], {draggable:true})
      .addTo(MapModule.map).bindPopup(escapeHTML(loc.name)).openPopup();
    MapModule.marker.on('dragend', (evt)=>{ const p=evt.target.getLatLng(); this.setLocation(p.lat, p.lng, "SeÃ§ilen Konum"); });
    sizeLayout();
  },

  loadLastUsedLocation(){
    const recents = JSON.parse(localStorage.getItem('fishingRecents') || '[]');
    if (recents.length > 0) { const last = recents[0]; this.setLocation(last.lat, last.lon, last.name); document.getElementById('locationInput').value = last.name; }
    else { APIModule.fetchData(this.currentLat, this.currentLon, this.currentDateOffset); }
  }
};

/* === Data === */
const DataModule = {
  fishes: [
    { name:"Levrek", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["KÄ±ÅŸ","Ä°lkbahar"], seaTemp:[9,18], airTemp:[5,18], windRange:[5,25], wave:[0.4,1.4], pressure:"low", moon:["Yeni Ay","Dolunay"], time:"ALACAKARANLIK_GECE", prefersRain:true, takim:`Spinning 2.7â€“3.0 m (10â€“30 g), PE 1.0â€“1.2, FC 0.28â€“0.35.`, yem:`CanlÄ± yemlik, fileto, minnow/silikon/jig.` },
    { name:"LÃ¼fer", regions:["BatÄ±","Orta"], seasons:["Sonbahar","KÄ±ÅŸ"], seaTemp:[12,22], airTemp:[8,24], windRange:[12,32], wave:[0.8,2.0], pressure:"low", moon:["Yeni Ay","Dolunay"], time:"ALACAKARANLIK_GECE", prefersRain:true, takim:`Spinning 20â€“40 g; FC 0.35â€“0.45; tel lider.`, yem:`CanlÄ± istavrit/zargana/sardalya; metal jig/rapala/kaÅŸÄ±k.` },
    { name:"EÅŸkina", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["KÄ±ÅŸ","TÃ¼m yÄ±l"], seaTemp:[14,21], airTemp:[8,18], windRange:[0,15], wave:[0,0.5], pressure:"low", moon:["Dolunay"], time:"GECE", prefersRain:true, takim:`Dip 0.35â€“0.45; 60â€“120 g; iÄŸne #2â€“#1/0.`, yem:`Teke, karides; kalamar, istavrit fileto.` },
    { name:"Granyoz", regions:["BatÄ±","Orta"], seasons:["Yaz","Sonbahar"], seaTemp:[20,27], airTemp:[22,34], windRange:[0,18], wave:[0.3,1.0], pressure:"stable", moon:["Dolunay"], time:"GÃœNDÃœZ_ALACAKARANLIK", prefersRain:false, takim:`AÄŸÄ±r jig 40â€“80 g; PE 1.5â€“2.0.`, yem:`CanlÄ± kÃ¼Ã§Ã¼k balÄ±k; kalamar; metal/silikon.` },
    { name:"Ä°zmarit", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["Ä°lkbahar","Yaz"], seaTemp:[15,24], airTemp:[14,24], windRange:[0,12], wave:[0,0.7], pressure:"low", moon:["Yeni Ay"], time:"GÃœNDÃœZ", prefersRain:false, takim:`ÅamandÄ±ra/LRF ULâ€‘L; iÄŸne #8â€“#10.`, yem:`Solucan, mamun, midye; mikro silikon.` },
    { name:"Ä°spari", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["Yaz"], seaTemp:[18,26], airTemp:[20,30], windRange:[0,12], wave:[0,0.5], pressure:"stable", moon:["Ä°lk DÃ¶rdÃ¼n"], time:"GÃœNDÃœZ", prefersRain:false, takim:`Hafif dip; iÄŸne #6â€“#8.` , yem:`Mamun, boru, karides, midye.` },
    { name:"Zargana", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["Yaz"], seaTemp:[20,27], airTemp:[24,34], windRange:[0,12], wave:[0,0.5], pressure:"stable", moon:["Yeni Ay"], time:"GÃœNDÃœZ", prefersRain:false, takim:`ÅamandÄ±ra/Spin; mini kaÅŸÄ±k 5â€“12 g.` , yem:`Åerit/iÌ‡pek; parlak kaÅŸÄ±k.` },
    { name:"Ä°stavrit", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["Sonbahar","KÄ±ÅŸ"], seaTemp:[10,18], airTemp:[8,18], windRange:[10,28], wave:[0.4,1.4], pressure:"low", moon:["Yeni Ay","Dolunay"], time:"GECE_ALACAKARANLIK", prefersRain:true, takim:`Ã‡apari 7â€“10â€™lu; 15â€“30 g kurÅŸun.` , yem:`TÃ¼yler; mikro silikon; minik hamsi.` },
    { name:"Sargoz", regions:["BatÄ±","Orta"], seasons:["Ä°lkbahar","Yaz"], seaTemp:[15,23], airTemp:[15,27], windRange:[0,18], wave:[0,0.8], pressure:"low", moon:["Yeni Ay"], time:"ALACAKARANLIK", prefersRain:false, takim:`Hafif dip/LRF; iÄŸne #4â€“#6.` , yem:`Mamun, sÃ¼lÃ¼nez, midye.` },
    { name:"KaragÃ¶z", regions:["BatÄ±","Orta"], seasons:["Ä°lkbahar","Sonbahar"], seaTemp:[15,24], airTemp:[15,28], windRange:[0,15], wave:[0,0.6], pressure:"low", moon:["Dolunay"], time:"GÃœNDÃœZ_ALACAKARANLIK", prefersRain:false, takim:`Hafif dip/ÅŸamandÄ±ra.` , yem:`Mamun, boru, karides, midye.` },
    { name:"Kefal", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["Ä°lkbahar","Sonbahar"], seaTemp:[12,24], airTemp:[14,24], windRange:[0,15], wave:[0,0.4], pressure:"low", moon:["Dolunay"], time:"GÃœNDÃœZ", prefersRain:true, takim:`ÅamandÄ±ra 3.0â€“3.9 m; iÄŸne #8â€“#12.` , yem:`Ekmek/hamur; mamun, boru.` },
    { name:"KÄ±rlangÄ±Ã§", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["KÄ±ÅŸ","Ä°lkbahar"], seaTemp:[11,19], airTemp:[6,18], windRange:[10,28], wave:[0.3,1.0], pressure:"low", moon:["Yeni Ay"], time:"GECE", prefersRain:true, takim:`Dip aÄŸÄ±r 80â€“120 g.` , yem:`Karides, fileto, kalamar.` },
    { name:"Barbunya", regions:["BatÄ±","Orta"], seasons:["Yaz"], seaTemp:[18,25], airTemp:[20,30], windRange:[0,12], wave:[0,0.5], pressure:"stable", moon:["Ä°lk DÃ¶rdÃ¼n"], time:"ALACAKARANLIK", prefersRain:false, takim:`Ä°nce dip 30â€“60 g.` , yem:`Solucan, mamun, midye, boru.` },
    { name:"Tekir", regions:["DoÄŸu"], seasons:["Ä°lkbahar","Yaz","Sonbahar"], seaTemp:[16,24], airTemp:[16,26], windRange:[0,15], wave:[0,0.8], pressure:"stable", moon:["Ä°lk DÃ¶rdÃ¼n"], time:"GÃœNDÃœZ", prefersRain:false, takim:`Ä°nce dip 20â€“40 g.` , yem:`Solucan, boru kurdu, mamun.` },
    { name:"Ä°skorpit", regions:["BatÄ±","Orta","DoÄŸu"], seasons:["TÃ¼m yÄ±l"], seaTemp:[10,24], airTemp:[8,28], windRange:[0,22], wave:[0.4,1.2], pressure:"any", moon:["Dolunay"], time:"KARMA", prefersRain:false, takim:`Dip/Zoka 50â€“100 g.` , yem:`Ä°stavrit fileto, karides.` },
    { name:"Kalkan", regions:["BatÄ±","Orta"], seasons:["KÄ±ÅŸ","Ä°lkbahar"], seaTemp:[8,17], airTemp:[4,18], windRange:[0,15], wave:[0,0.8], pressure:"low", moon:["Yeni Ay"], time:"GECE", prefersRain:false, takim:`Surf aÄŸÄ±r; 100â€“150 g.` , yem:`CanlÄ± istavrit; geniÅŸ ÅŸerit.` },
    { name:"Palamut", regions:["BatÄ±","Orta"], seasons:["Sonbahar"], seaTemp:[16,23], airTemp:[14,22], windRange:[10,30], wave:[0.5,1.5], pressure:"low", moon:["Yeni Ay","Dolunay"], time:"ALACAKARANLIK", prefersRain:false, takim:`Spin/Jig 30â€“60 g.` , yem:`Metal jig; minnow 11â€“14 cm.` },
    { name:"Mezgit", regions:["Orta","DoÄŸu"], seasons:["TÃ¼m yÄ±l"], seaTemp:[8,18], airTemp:[6,18], windRange:[0,20], wave:[0,1.0], pressure:"any", moon:["Dolunay"], time:"GÃœNDÃœZ_GECE", prefersRain:false, takim:`Dip Ã§oklu kÃ¶stek.` , yem:`Solucan, mamun, balÄ±k parÃ§alarÄ±.` },
    { name:"Uskumru", regions:["BatÄ±","Orta"], seasons:["Ä°lkbahar","Yaz"], seaTemp:[14,22], airTemp:[14,26], windRange:[10,30], wave:[0.5,1.2], pressure:"low", moon:["Yeni Ay","Dolunay"], time:"ALACAKARANLIK_GÃœNDÃœZ", prefersRain:false, takim:`Jig/KaÅŸÄ±k 20â€“40 g.` , yem:`Metal jig/kaÅŸÄ±k; minnow.` },
    { name:"Kolyoz", regions:["BatÄ±","Orta"], seasons:["Yaz","Sonbahar"], seaTemp:[14,23], airTemp:[14,24], windRange:[10,28], wave:[0.5,1.2], pressure:"low", moon:["Yeni Ay"], time:"ALACAKARANLIK", prefersRain:false, takim:`Spin metal 20â€“40 g.` , yem:`Metal/kaÅŸÄ±k; minnow.` },
    { name:"Ã‡upra", regions:["BatÄ±","Orta"], seasons:["Yaz","Sonbahar"], seaTemp:[16,25], airTemp:[16,26], windRange:[0,15], wave:[0,0.6], pressure:"stable", moon:["Ä°lk DÃ¶rdÃ¼n"], time:"GÃœNDÃœZ", prefersRain:false, takim:`Dip/ÅamandÄ±ra ML.` , yem:`Kabuklular, midye, karides.` },
    { name:"MÄ±rmÄ±r", regions:["DoÄŸu"], seasons:["Yaz","Sonbahar"], seaTemp:[18,26], airTemp:[20,30], windRange:[0,15], wave:[0,0.5], pressure:"stable", moon:["Ä°lk DÃ¶rdÃ¼n"], time:"GÃœNDÃœZ_ALACAKARANLIK", prefersRain:false, takim:`Hafif dip 20â€“40 g.` , yem:`Boru kurdu, mamun, sÃ¼lÃ¼nez.` },
    { name:"Somon", regions:[], seasons:["TÃ¼m yÄ±l"], seaTemp:[0,0], airTemp:[0,0], windRange:[0,0], wave:[0,0], pressure:"any", moon:["Yeni Ay"], time:"GÃœNDÃœZ", prefersRain:false, takim:`(Bilgi amaÃ§lÄ±)`, yem:`(Bilgi amaÃ§lÄ±)` }
  ],
  getSeason() {
    const m = new Date().getMonth() + 1;
    if ([12,1,2].includes(m)) return "KÄ±ÅŸ";
    if ([3,4,5].includes(m)) return "Ä°lkbahar";
    if ([6,7,8].includes(m)) return "Yaz";
    return "Sonbahar";
  },
  getMoonPhase(date = new Date()) {
    let y=date.getUTCFullYear(), mo=date.getUTCMonth()+1, d=date.getUTCDate();
    if (mo==1||mo==2){y--;mo+=12;}
    let a=Math.floor(y/100), b=Math.floor(a/4), c=2-a+b;
    let e=Math.floor(365.25*(y+4716)), f=Math.floor(30.6001*(mo+1));
    let jd=c+d+e+f-1524.5, days=jd-2451549.5, newMoons=days/29.53058867, phase=(newMoons-Math.floor(newMoons))*29.53058867;
    if (phase<1.5) return "Yeni Ay";
    if (phase<13.5) return "Hilal - Ä°lk DÃ¶rdÃ¼n";
    if (phase<16.5) return "Dolunay CivarÄ±";
    return "Son DÃ¶rdÃ¼n - Yeni Ay CivarÄ±";
  },
  getMoonPhaseEmoji(date = new Date()) {
    let y=date.getUTCFullYear(), mo=date.getUTCMonth()+1, d=date.getUTCDate();
    if (mo==1||mo==2){y--;mo+=12;}
    let a=Math.floor(y/100), b=Math.floor(a/4), c=2-a+b;
    let e=Math.floor(365.25*(y+4716)), f=Math.floor(30.6001*(mo+1));
    let jd=c+d+e+f-1524.5, days=jd-2451549.5, newMoons=days/29.53058867, phase=(newMoons-Math.floor(newMoons))*29.53058867;
    if (phase<1.5) return "ğŸŒ‘"; if (phase<13.5) return "ğŸŒ“"; if (phase<16.5) return "ğŸŒ•"; return "ğŸŒ—";
  }
};

/* === Skor === */
const ScoringModule = {
  color(sc){ return sc>90?'#2563eb':sc>70?'#16a34a':sc>50?'#f59e0b':'#dc2626'; },
  gradedRangeScore(v,min,max,p,tol=0.15){ if(max<=min||p===0||v==null) return 0; const r=max-min, s=min+tol*r, e=max-tol*r; if(v>=s&&v<=e) return p; if((v>=min-tol*r&&v<s)||(v>e&&v<=max+tol*r)) return p*0.5; return 0; },
  calculate(f, env, label){
    let s=0, season=DataModule.getSeason(), moon=DataModule.getMoonPhase();
    if(f.seasons.includes(season)||f.seasons.includes("TÃ¼m yÄ±l")) s+=20;
    if(f.time.includes(label)) s+=15;
    if(f.pressure==="low" && env.pressure<1013) s+=8;
    else if(f.pressure==="stable" && env.pressure>=1012 && env.pressure<=1018) s+=8;
    else if(f.pressure==="any") s+=4;
    if(f.moon?.some?.(m=>moon.includes(m))) s+=8;
    if(f.prefersRain && env.precipProbability>40) s+=8;
    s+=this.gradedRangeScore(env.seaTemp, f.seaTemp[0], f.seaTemp[1], 20);
    s+=this.gradedRangeScore(env.airTemp, f.airTemp[0], f.airTemp[1], 12);
    if(f.wave) s+=this.gradedRangeScore(env.wave, f.wave[0], f.wave[1], 7);
    if(f.windRange) s+=this.gradedRangeScore(env.wind, f.windRange[0], f.windRange[1], 10);
    if((env.wave||0)>1.2||(env.wind||0)>25) s+=2;
    return Math.max(0, Math.min(100, Math.round(s)));
  }
};

/* === Fetch Timeout + Abort === */
async function fetchWithTimeout(url, ms = 10000) {
  const ctrl = new AbortController();
  const id = setTimeout(() => ctrl.abort(), ms);
  try { return await fetch(url, { signal: ctrl.signal }); }
  finally { clearTimeout(id); }
}

/* === API (3 saatlik slotlar) === */
const APIModule = {
  slots: buildThreeHourSlots(),

  async fetchData(lat, lon, dayOffset = 0) {
    document.getElementById('loading').style.display='block';

    const targetDate = new Date(); targetDate.setDate(targetDate.getDate()+dayOffset);
    const dateStr = targetDate.toISOString().split('T')[0];

    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=sunrise,sunset&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,surface_pressure,cloud_cover,precipitation_probability&start_date=${dateStr}&end_date=${dateStr}&timezone=auto&wind_speed_unit=kmh`;
    const marineUrl  = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=sea_surface_temperature,wave_height&start_date=${dateStr}&end_date=${dateStr}&timezone=auto`;

    const cacheKey = `wx:${lat.toFixed(3)},${lon.toFixed(3)}:${dateStr}`;
    try{
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        const { wData, mData } = JSON.parse(cached);
        this.processData(wData, mData, targetDate);
        document.getElementById('loading').style.display='none';
        return;
      }
    } catch (_) { /* yoksay */ }

    try{
      const [wRes,mRes]=await Promise.all([
        fetchWithTimeout(weatherUrl, 12000),
        fetchWithTimeout(marineUrl, 12000)
      ]);
      const wData=await wRes.json(), mData=await mRes.json();
      if(!wData?.hourly?.time?.length) throw new Error("Hava verisi yok");

      if(!mData?.hourly?.time?.length){
        mData.hourly = { time: wData.hourly.time.slice(),
          sea_surface_temperature: wData.hourly.time.map(()=>18),
          wave_height: wData.hourly.time.map(()=>0.3) };
      }

      try { localStorage.setItem(cacheKey, JSON.stringify({ wData, mData })); } catch (_){}

      this.processData(wData, mData, targetDate);
    }catch(e){
      console.error(e);
      showToast("Veri alÄ±namadÄ±. LÃ¼tfen daha sonra tekrar deneyin.", 'error');
    }
    finally{ document.getElementById('loading').style.display='none'; }
  },

  processData(wData, mData, targetDate){
    const sunrise = wData?.daily?.sunrise?.[0] ? wData.daily.sunrise[0].split('T')[1].slice(0,5) : '06:00';
    const sunset  = wData?.daily?.sunset?.[0]  ? wData.daily.sunset[0].split('T')[1].slice(0,5)  : '18:00';

    const hourly = wData.hourly.time.map((t,i)=>({
      time:new Date(t),
      airTemp:wData.hourly.temperature_2m?.[i] ?? null,
      wind:wData.hourly.wind_speed_10m?.[i] ?? null,
      windDirDeg:wData.hourly.wind_direction_10m?.[i] ?? null,
      pressure:wData.hourly.surface_pressure?.[i] ?? null,
      cloud:wData.hourly.cloud_cover?.[i] ?? 0,
      precipProbability:wData.hourly.precipitation_probability?.[i] ?? 0,
      seaTemp:mData.hourly.sea_surface_temperature?.[i] ?? 18,
      wave:mData.hourly.wave_height?.[i] ?? 0.3
    }));

    this.slots = buildThreeHourSlots();
    this.slots.forEach(slot=>{
      const relevant=hourly.filter(d=>slot.hours.includes(d.time.getHours()));
      if(!relevant.length) return;
      const avg=prop=>{ const vals=relevant.map(d=>d[prop]).filter(v=>typeof v==='number'); return vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : null; };
      slot.env={
        airTemp: Math.round(avg('airTemp') ?? 0),
        seaTemp: Math.round(avg('seaTemp') ?? 0),
        wind: Math.round(avg('wind') ?? 0),
        windDirDeg: relevant[0].windDirDeg ?? null,
        windDir: this.cardinal(relevant[0].windDirDeg),
        windDirLong: this.cardinalLong(relevant[0].windDirDeg),
        wave: parseFloat((avg('wave') ?? 0).toFixed(1)),
        pressure: Math.round(avg('pressure') ?? 1015),
        weather: ((relevant[0].cloud ?? 0) < 30 ? "AÃ§Ä±k" : (relevant[0].cloud ?? 0) < 70 ? "Bulutlu" : "KapalÄ±"),
        precipProbability: Math.round(avg('precipProbability') ?? 0),
        selectedDate: targetDate.toLocaleDateString('tr-TR',{weekday:'long', day:'numeric', month:'long'}),
        sunrise, sunset
      };
      const centerHour = Math.round((slot.hours[0] + slot.hours[2]) / 2);
      slot.timeLabel = labelBySunClock(centerHour, sunrise, sunset);
    });

    UIModule.renderCards();
    sizeLayout();
  },

  cardinal(deg){ if(deg==null || isNaN(deg)) return "â€”"; const d=["K","KD","D","GD","G","GB","B","KB"]; return d[Math.round(deg/45)%8]; },
  cardinalLong(deg){ if(deg==null || isNaN(deg)) return "DeÄŸiÅŸken"; const d=["Kuzey","KuzeydoÄŸu","DoÄŸu","GÃ¼neydoÄŸu","GÃ¼ney","GÃ¼neybatÄ±","BatÄ±","KuzeybatÄ±"]; return d[Math.round(deg/45)%8]; }
};

/* === Harita === */
const MapModule = {
  map:null, marker:null,
  init(){
    this.map = L.map('map').setView([App.currentLat, App.currentLon], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(this.map);
    this.setMarker({lat:App.currentLat,lng:App.currentLon}, App.currentLocationName);
    this.map.on('click', e=>{ this.setMarker(e.latlng,"SeÃ§ilen Konum"); App.setLocation(e.latlng.lat, e.latlng.lng, "SeÃ§ilen Konum"); });
    setTimeout(sizeLayout, 100);
  },
  setMarker(latlng, popupText=""){
    if(this.marker) this.map.removeLayer(this.marker);
    this.marker=L.marker(latlng,{draggable:true}).addTo(this.map);
    if(popupText) this.marker.bindPopup(escapeHTML(popupText)).openPopup();
    this.marker.on('dragend',evt=>{ const p=evt.target.getLatLng(); App.setLocation(p.lat,p.lng,"SeÃ§ilen Konum"); });
  },
  async searchLocation(q){
    try{
      const res=await fetchWithTimeout(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=tr`, 12000);
      const data=await res.json();
      if(data.results && data.results[0]){
        const best=data.results[0]; const {latitude, longitude, name, country_code}=best;
        this.map.setView([latitude, longitude], 11);
        this.setMarker({lat:latitude,lng:longitude}, name);
        const nm = country_code ? `${name} (${country_code})` : name;
        App.setLocation(latitude, longitude, nm);
      }else showToast("Lokasyon bulunamadÄ±!", 'error');
    }catch(err){
      showToast("Lokasyon aramasÄ± baÅŸarÄ±sÄ±z.", 'error');
    }
    finally{ sizeLayout(); }
  }
};

/* === UI === */
const UIModule = {
  activeIndex:0,
  inRegionFishes(){ return DataModule.fishes.filter(f=>f.regions?.includes(App.currentRegion)); },
  outRegionFishes(){ return DataModule.fishes.filter(f=>Array.isArray(f.regions)&&!f.regions.includes(App.currentRegion)); },

  renderCards(){
    const cards=document.getElementById('cards'); cards.innerHTML='';
    const inRegion=this.inRegionFishes();

    const frag = document.createDocumentFragment();

    APIModule.slots.forEach((slot,i)=>{
      if(!slot.env) return;
      const ranked=inRegion.map(f=>({fish:f, score:ScoringModule.calculate(f,slot.env,slot.timeLabel)}))
                           .sort((a,b)=>b.score-a.score);
      const card=document.createElement('div'); card.className='card';
      card.setAttribute('role','button');
      card.setAttribute('tabindex','0');

      if(!ranked.length){
        card.setAttribute('aria-label', `${slot.t} iÃ§in uygun tÃ¼r yok`);
        card.innerHTML=`<b>${slot.t}</b><div class="small" style="margin-top:8px">Bu bÃ¶lgede uygun tÃ¼r bulunamadÄ±.</div>`;
        card.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') card.click(); });
        frag.appendChild(card); return;
      }

      const best=ranked[0];
      const windLabel=`${slot.env.wind} km/sa ${slot.env.windDir}`, windTitle=`${slot.env.wind} km/sa â€“ ${slot.env.windDirLong}`;
      const top3=ranked.slice(0,3).map((x,idx)=>{const p=idx===0?"ğŸ¥‡":idx===1?"ğŸ¥ˆ":"ğŸ¥‰"; return `<span class="chip" style="border-color:${ScoringModule.color(x.score)}">${p} ${x.fish.name} ${x.score}%</span>`;}).join(' ');
      const fishBadge = fishIcons(best.score);
      card.setAttribute('aria-label',`${slot.t} iÃ§in en iyi balÄ±k: ${best.fish.name} ${best.score}%`);
      card.innerHTML=`
        <b>${slot.t}</b>
        <div style="margin:8px 0; font-weight:700">${fishBadge ? fishBadge + ' ' : ''}${best.fish.name} â€” <span style="color:${ScoringModule.color(best.score)}">${best.score}%</span></div>
        <div class="env">
          ğŸŒ¡ï¸ ${slot.env.airTemp}Â°C â€¢ ğŸŒŠ ${slot.env.wave} m<br>
          <span title="${escapeHTML(windTitle)}">ğŸŒ¬ï¸ ${escapeHTML(windLabel)}</span> â€¢ â›… ${escapeHTML(slot.env.weather)}
        </div>
        <div class="top3 small">${top3}</div>`;
      card.onclick=()=>this.openModal(i);
      card.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') card.click(); });
      frag.appendChild(card);
    });

    cards.appendChild(frag);
    sizeLayout();
  },

  openModal(activeIndex){
    this.activeIndex=activeIndex;
    const modal=document.getElementById('modal'), sheet=document.getElementById('modalSheet');
    modal.style.display='flex'; setTimeout(()=>sheet.focus(),0);
    this.buildTimeline(activeIndex);
  },
  closeModal(){ document.getElementById('modal').style.display='none'; },

  buildTimeline(active){
    this.activeIndex=active;
    const timeline=document.getElementById('timeline'); timeline.innerHTML='';
    APIModule.slots.forEach((slot,i)=>{
      const el=document.createElement('div'); el.className='slot'+(i===active?' active':''); el.textContent=slot.t; el.onclick=()=>{this.buildTimeline(i);};
      timeline.appendChild(el); if(i===active) this.renderSlot(slot);
    });
  },

  renderSlot(slot){
    document.getElementById('slotTitle').textContent = `${slot.t} â€“ ${slot.timeLabel} (${slot.env.selectedDate}) â€¢ ${RegionModule.textMap[App.currentRegion]}`;
    const envGrid=document.getElementById('envGrid');
    const windLabel=`${slot.env.wind} km/sa ${slot.env.windDir}`, windTitle=`${slot.env.wind} km/sa â€“ ${slot.env.windDirLong}`;
    envGrid.innerHTML=`
      <div class="env-box">â›…<br>${escapeHTML(slot.env.weather)}</div>
      <div class="env-box">ğŸŒ§ï¸ YaÄŸÄ±ÅŸ<br>${slot.env.precipProbability}%</div>
      <div class="env-box">ğŸŒ… DoÄŸum<br>${slot.env.sunrise}</div>
      <div class="env-box">ğŸŒ‡ BatÄ±m<br>${slot.env.sunset}</div>
      <div class="env-box">ğŸŒ¡ï¸ Hava<br>${slot.env.airTemp}Â°C</div>
      <div class="env-box" title="${escapeHTML(windTitle)}">ğŸŒ¬ï¸ RÃ¼zgar<br>${escapeHTML(windLabel)}</div>
      <div class="env-box">ğŸŒŠ Dalga<br>${slot.env.wave} m</div>
      <div class="env-box">ğŸŒ¡ï¸ Deniz<br>${slot.env.seaTemp}Â°C</div>
      <div class="env-box">ğŸŒ€ BasÄ±nÃ§<br>${slot.env.pressure} hPa</div>`;

    const fishList=document.getElementById('fishList');
    const inRegion=this.inRegionFishes().map(f=>({fish:f,score:ScoringModule.calculate(f,slot.env,slot.timeLabel)})).sort((a,b)=>b.score-a.score);
    const outRegion=this.outRegionFishes().map(f=>({fish:f,score:ScoringModule.calculate(f,slot.env,slot.timeLabel)})).sort((a,b)=>b.score-a.score);

    let html='';
    if(!inRegion.length){ html+=`<div class="small">Bu bÃ¶lge iÃ§in uygun tÃ¼r bulunamadÄ±.</div>`; }
    else{
      html+=inRegion.map(x=>{
        let comment="", c="";
        if(x.score>=90){ comment="Bol av bekleniyor! Harika koÅŸullar ğŸŸğŸŸğŸŸ"; c="#16a34a";}
        else if(x.score>=70){ comment="Ä°yi av ihtimali yÃ¼ksek. ÅansÄ±n aÃ§Ä±k olsun! ğŸŸğŸŸ"; c="#16a34a";}
        else if(x.score>=50){ comment="Orta dÃ¼zeyde aktivite. SabÄ±rlÄ± ol ğŸŸ"; c="#f59e0b";}
        else if(x.score>=30){ comment="ZayÄ±f aktivite. Zor olabilir, ama ÅŸansÄ±nÄ± dene"; c="#f59e0b";}
        else { comment="Ã‡ok dÃ¼ÅŸÃ¼k ihtimal. BugÃ¼n baÅŸka balÄ±klara bak"; c="#dc2626";}
        const heavyHint=(slot.env.wave>1.2||slot.env.wind>25)? `<div class="small">ğŸ’¡ KoÅŸullar zor (dalga/rÃ¼zgar yÃ¼ksek). Daha <b>aÄŸÄ±r takÄ±m</b> ve <b>daha kalÄ±n misina</b> tercih edebilirsin.</div>` : "";
        return `
          <div class="fish">
            <div class="fish-head" onclick="this.nextElementSibling.classList.toggle('open')" role="button" aria-label="${x.fish.name} detaylarÄ±nÄ± aÃ§">
              <b>${fishIcons(x.score)} ${x.fish.name} â€” <span style="color:${ScoringModule.color(x.score)}">${x.score}%</span></b>
            </div>
            <div class="detail">
              <div class="bar"><div style="width:${x.score}%;background:${ScoringModule.color(x.score)}"></div></div>
              <div class="av-comment" style="color:${c}">${comment}</div>
              <div class="takim-yem"><span class="takim-icon">ğŸ£ğŸ‘¤</span> <span class="small">${x.fish.takim}</span></div>
              <div class="takim-yem"><span class="takim-icon">ğŸª±</span> <span class="small">${x.fish.yem}</span></div>
              ${heavyHint}
              <div class="small">${DataModule.getMoonPhaseEmoji()} Ay evresi: ${DataModule.getMoonPhase()}</div>
            </div>
          </div>`;
      }).join('');
    }

    if(outRegion.length){
      html+=`<div class="small" style="margin-top:12px;opacity:.8">BÃ¶lgede nadir / uygun olmayan tÃ¼rler:</div>`;
      html+=outRegion.map(x=>`
        <div class="fish" style="opacity:.7">
          <div class="fish-head" onclick="this.nextElementSibling.classList.toggle('open')" role="button" aria-label="${x.fish.name} detaylarÄ±nÄ± aÃ§">
            <b>${x.fish.name} â€” <span style="color:${ScoringModule.color(x.score)}">${x.score}%</span></b>
          </div>
          <div class="detail">
            <div class="nadir">Bu bÃ¶lgede nadir</div>
            <div class="bar"><div style="width:${x.score}%;background:${ScoringModule.color(x.score)}"></div></div>
            <div class="takim-yem"><span class="takim-icon">ğŸ£ğŸ‘¤</span> <span class="small">${x.fish.takim}</span></div>
            <div class="takim-yem"><span class="takim-icon">ğŸª±</span> <span class="small">${x.fish.yem}</span></div>
            <div class="small">${DataModule.getMoonPhaseEmoji()} Ay evresi: ${DataModule.getMoonPhase()}</div>
          </div>
        </div>`).join('');
    }

    fishList.innerHTML=html;
  }
};

/* === Dikey yerleÅŸim === */
function sizeLayout(){
  const vh = window.innerHeight;
  const headerH = document.querySelector('header')?.getBoundingClientRect().height || 0;
  const panelH  = document.querySelector('.location-panel')?.getBoundingClientRect().height || 0;
  const mapH    = document.getElementById('map')?.getBoundingClientRect().height || 0;
  const cards   = document.getElementById('cards');
  const margins = 24;
  const avail = Math.max(220, vh - (headerH + panelH + mapH + margins));
  if (cards) { cards.style.height = `${Math.round(avail)}px`; }
}
window.addEventListener('load', sizeLayout);
window.addEventListener('resize', sizeLayout);
if (window.ResizeObserver) {
  const ro = new ResizeObserver(()=> sizeLayout());
  ro.observe(document.body);
}

/* === Modal eriÅŸilebilirliÄŸi === */
function setupModalInteractions(){
  const modal = document.getElementById('modal');
  const sheet = document.getElementById('modalSheet');
  const closeBtn = document.getElementById('modalClose');

  modal.addEventListener('click', (e) => {
    if (e.target.id === 'modal') UIModule.closeModal();
  });

  closeBtn.addEventListener('click', () => UIModule.closeModal());

  sheet.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') return;
    const focusable = sheet.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (!first || !last) return;
    if (e.shiftKey) {
      if (document.activeElement === first) { last.focus(); e.preventDefault(); }
    } else {
      if (document.activeElement === last) { first.focus(); e.preventDefault(); }
    }
  });
}

/* === Rozet: mevcut konuma git === */
function setupRegionInline(){
  const regionEl = document.getElementById('regionInline');
  if (!regionEl) return;

  const goToCurrent = () => {
    try {
      const lat = App.currentLat, lon = App.currentLon;
      const name = App.currentLocationName || "Mevcut Konum";

      if (MapModule?.map?.flyTo) {
        MapModule.map.flyTo([lat, lon], 12, { duration: 0.6 });
      } else {
        MapModule.map.setView([lat, lon], 12);
      }

      if (!MapModule.marker) {
        MapModule.setMarker({lat, lng: lon}, name);
      } else {
        MapModule.marker.setLatLng([lat, lon]);
        MapModule.marker.bindPopup(escapeHTML(name)).openPopup();
      }

      // Hafif gÃ¶rsel geri bildirim
      regionEl.style.boxShadow = "0 0 0 6px rgba(37,99,235,0.25)";
      setTimeout(()=> regionEl.style.boxShadow = "", 400);
    } catch (e) {
      showToast("Mevcut konuma gidilemedi.", "error");
    }
  };

  regionEl.addEventListener('click', goToCurrent);
  regionEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      goToCurrent();
    }
  });
}

/* === Rozet iÃ§indeki konum ikonu: geolokasyon al === */
function setupRegionLocateIcon(){
  const icon = document.getElementById('regionLocateIcon');
  if (!icon) return;
  icon.addEventListener('click', (e) => {
    e.stopPropagation(); // Rozet tÄ±klamasÄ±nÄ± tetikleme
    if (!navigator.geolocation) { showToast("TarayÄ±cÄ±nÄ±z konum desteÄŸi saÄŸlamÄ±yor.", 'error'); return; }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        if (MapModule?.map?.flyTo) {
          MapModule.map.flyTo([latitude, longitude], 12, { duration: 0.6 });
        } else {
          MapModule.map.setView([latitude, longitude], 12);
        }
        MapModule.setMarker({ lat: latitude, lng: longitude }, "Benim Konumum");
        App.setLocation(latitude, longitude, "Benim Konumum");
      },
      err => showToast("Konum alÄ±namadÄ±: " + err.message, 'error'),
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });
}

/* === Mobil scroll ipucu === */
function setupScrollHint(){
  const hintEl = document.getElementById('scrollHint');
  const cardsEl = document.getElementById('cards');
  if (!hintEl || !cardsEl) return;

  // Ä°lk kez veya uzun aradan sonra gÃ¶ster (24 saat)
  const key = 'fishingScrollHintShownAt';
  const last = parseInt(localStorage.getItem(key) || '0', 10);
  const now = Date.now();
  const dayMs = 24*60*60*1000;

  const shouldShow = (now - last) > dayMs;
  if (shouldShow && window.matchMedia('(max-width: 767px)').matches) {
    hintEl.style.display = 'block';
    // KullanÄ±cÄ± aÅŸaÄŸÄ± kaydÄ±rÄ±rsa gizle ve zamanÄ± kaydet
    const onScroll = () => {
      if (cardsEl.scrollTop > 20) {
        hintEl.style.display = 'none';
        localStorage.setItem(key, String(now));
        cardsEl.removeEventListener('scroll', onScroll);
      }
    };
    cardsEl.addEventListener('scroll', onScroll);

    // 6 saniye sonra kendiliÄŸinden kaydet ve gizle (rahatsÄ±z etmemesi iÃ§in)
    setTimeout(()=>{
      hintEl.style.display = 'none';
      localStorage.setItem(key, String(now));
      cardsEl.removeEventListener('scroll', onScroll);
    }, 6000);
  } else {
    hintEl.style.display = 'none';
  }
}

/* === Arama ve PaylaÅŸ === */
document.getElementById('searchButton').addEventListener('click', () => App.searchLocation());
document.getElementById('shareButton').addEventListener('click', ()=>{
  const title=document.getElementById('slotTitle').textContent;
  const location=document.getElementById('locationInput').value || App.currentLocationName || "Belirtilen Lokasyon";
  const d=new Date(); d.setDate(d.getDate()+App.currentDateOffset);
  const formattedDate=d.toLocaleDateString('tr-TR',{weekday:'long', day:'numeric', month:'long'});
  const panelUrl=window.location.href;
  const activeIdx=UIModule.activeIndex ?? 0; const activeSlot=APIModule.slots[activeIdx]; const env=activeSlot?.env || {};
  const windLabel=`${env?.wind ?? 'â€”'} km/sa ${env?.windDirLong || env?.windDir || ''}`, waveLabel=`${env?.wave ?? 'â€”'} m`;
  const text = `ğŸ£ BalÄ±k AvÄ± Tahmini

ğŸ“ ${location}
ğŸ“… ${formattedDate}
â° ${title}
ğŸŒ¬ï¸ RÃ¼zgar: ${windLabel}
ğŸŒŠ Dalga: ${waveLabel}

DetaylÄ± tahmin iÃ§in paneli ziyaret et!
ğŸ”— ${panelUrl}`;
  if (navigator.share) {
    navigator.share({title:'BalÄ±k AvÄ± Tahmini', text}).catch(()=> navigator.clipboard.writeText(text).then(()=>showToast("Metin panoya kopyalandÄ±!")) );
  } else { navigator.clipboard.writeText(text).then(()=>showToast("Metin panoya kopyalandÄ±!")); }
});

/* === BaÅŸlat === */
App.init();
</script>
</body>
</html>
